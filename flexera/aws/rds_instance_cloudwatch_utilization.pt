name "AWS Rightsize RDS Instances [Demo]"
rs_pt_ver 20180301
type "policy"
short_description "Demo policy for generating recommendations. See [README](https://github.com/flexera-public/optima-tools/tree/master/flexera/) for more information."
long_description ""
severity "low"
category "Cost"
default_frequency "daily"
info(
  version: "3.1",
  provider: "AWS",
  service: "RDS",
  policy_set: "RightSize Database Services"
)

###############################################################################
# Datasources
###############################################################################

datasource "ds_filtered_results" do
  request do
    verb "GET"
    host "raw.githubusercontent.com"
    path "/flexera-public/optima-tools/master/flexera/data/aws/rds_instance_cloudwatch_utilization.json"
    header "User-Agent", "RS Policies"
  end
end

###############################################################################
# Policy
###############################################################################

policy "pol_utilization" do
  validate $ds_filtered_results do
    summary_template "AWS Account ID: {{with index data 0}}{{ .accountId }}{{end}} - {{ len data }} AWS RDS instances with inefficient utilization"
    check eq(1, 0)
    export do
      resource_level true
      field "accountID" do
        label "Account Id"
        path "accountId"
      end
      field "accountName" do
        label "Account Name"
      end
      field "region" do
        label "Region"
      end
      field "id" do
        label "Instance Id"
        path "dbInstanceIdentifier"
      end
      field "platform" do
        label "Platform"
        path "databaseEngine"
      end
      field "resourceType" do
        label "Current Instance Class"
        path "dbInstanceClass"
      end
      field "newResourceType" do
        label "Recommended Instance Class"
        path "recommended_size"
      end
      field "availabilityZone" do
        label "Availability Zone"
      end
      field "cpuAverage" do
        label "CPU Average %"
        path "percent_cpu_avg"
      end
      field "lookbackPeriod" do
        label "Lookback Period"
      end
      field "databaseEngine" do
        label "Database Engine"
      end
      field "engineVersion" do
        label "Engine Version"
      end
      field "threshold" do
        label "CPU Threshold"
      end
    end
  end
end
