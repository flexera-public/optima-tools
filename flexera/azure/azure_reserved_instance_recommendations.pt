name "Azure Reserved Instances Recommendations [Demo]"
rs_pt_ver 20180301
type "policy"
short_description "A policy that sends email notifications when Azure RI Recommendations are identified. NOTE: These RI Purchase Recommendations are generated by Microsoft Azure. See the [README](https://github.com/flexera-public/policy_templates/tree/master/cost/azure/reserved_instances/recommendations) and [docs.flexera.com/flexera/EN/Automation](https://docs.flexera.com/flexera/EN/Automation/AutomationGS.htm) to learn more."
long_description ""
severity "medium"
category "Cost"
default_frequency "daily"
info(
  version: "2.5",
  provider: "Azure",
  service: "",
  policy_set: "",
  publish: 'false'
)

###############################################################################
# Parameters
###############################################################################

parameter "param_savings_threshold" do
  category "RI"
  label "Net Savings Threshold"
  description "Specify the minimum net savings that should result in a recommendation"
  default 100
  type "number"
end

###############################################################################
# Datasources
###############################################################################

datasource "ds_ri_normalization" do
  request do
    verb "GET"
    host "raw.githubusercontent.com"
    path "/flexera-public/optima-tools/master/flexera/data/azure/azure_reserved_instance_recommendations.json"
    header "User-Agent", "RS Policies"
  end
end

###############################################################################
# Policy
###############################################################################

policy "azure_ri_recommendations" do
  validate_each $ds_ri_normalization do
    summary_template "(Enrollment ID: {{parameters.param_enrollment}}): {{ len data }} Azure Reserved Instances Purchase Recommendations"
    check lt(to_n(val(item,"netSavings")), $param_savings_threshold)
    export do
      resource_level true
      field "skuName" do
        label "SKU Name"
      end
      field "term" do
        label "Term"
      end
      field "region" do
        label "Location"
      end
      field "netSavings" do
        label "Net Savings"
      end
      field "recommendedQuantity" do
        label "Total RI Quantity to Purchase"
      end
      field "costWithNoRI" do
        label "Total Current Cost (without RI)"
      end
      field "totalCostWithRI" do
        label "Total Cost if RI was purchased"
      end
      field "firstUsageDate" do
        label "First Usage Date"
      end
      field "id" do
        label "Resource MeterID"
        path "meterId"
      end
    end
  end
end
